<!DOCTYPE html>
<html lang="es">
<head><link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1db954">
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Hitster Valira</title>
<style>
body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    text-align: center;
    background-image: url("fondo.png");
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    font-family: Arial, sans-serif;
    color: white;
}
#mainContent {
    position: absolute;
    top: 18%;
    left: 50%;
    transform: translateX(-50%);
}
h1 {
    font-size: 3rem;
    text-shadow: 2px 2px 10px black;
}
button {
    margin-top: 20px;
    padding: 22px 40px;
    font-size: 1.2rem;
    background-color: #1db954;
    color: white;
    border: none;
    border-radius: 40px;
    cursor: pointer;
    transition: 0.2s;
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
}
button:hover {
    transform: scale(1.1);
}
#particles {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: -1;
}
</style>
</head>
<body>

<canvas id="particles"></canvas>

<div id="mainContent">
    <h1>HITSTER VALIRA</h1>
    <button id="btnScan">Escanear QR</button>
</div>

<!-- Botón de instalación PWA -->
<button id="installBtn" style="display:none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 15px 30px; font-size: 1.2rem; background-color: #1db954; color: white; border: none; border-radius: 40px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 10000;">Instalar App</button>

<!-- Partículas -->
<script>
const canvas = document.getElementById("particles");
const ctx = canvas.getContext("2d");
canvas.width = innerWidth;
canvas.height = innerHeight;

const particles = [];
for (let i = 0; i < 80; i++) {
    particles.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        r: Math.random() * 3 + 1,
        dx: (Math.random() - 0.5) * 0.5,
        dy: (Math.random() - 0.5) * 0.5
    });
}

function animate() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    particles.forEach(p => {
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
        ctx.fillStyle = "rgba(255,255,255,0.7)";
        ctx.fill();
        p.x += p.dx;
        p.y += p.dy;
        if (p.x < 0 || p.x > canvas.width) p.dx *= -1;
        if (p.y < 0 || p.y > canvas.height) p.dy *= -1;
    });
    requestAnimationFrame(animate);
}
animate();
</script>
<button id="installBtn" style="display:none;">Instalar App</button>

<!-- Lector QR -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
const btn = document.getElementById("btnScan");

btn.onclick = () => {
    // Contenedor completo
    const qrBox = document.createElement("div");
    qrBox.style.position = "fixed";
    qrBox.style.top = "0";
    qrBox.style.left = "0";
    qrBox.style.width = "100%";
    qrBox.style.height = "100%";
    qrBox.style.background = "rgba(0,0,0,0.85)";
    qrBox.style.display = "flex";
    qrBox.style.justifyContent = "center";
    qrBox.style.alignItems = "center";
    qrBox.style.zIndex = "9999";

    // Lector responsivo
    const readerDiv = document.createElement("div");
    readerDiv.id = "reader";
    readerDiv.style.width = "90vw";
    readerDiv.style.height = "70vh";
    readerDiv.style.maxWidth = "500px";
    readerDiv.style.maxHeight = "700px";
    readerDiv.style.position = "relative";
    qrBox.appendChild(readerDiv);

    // Botón cerrar siempre visible
    const closeBtn = document.createElement("button");
    closeBtn.textContent = "Cerrar";
    closeBtn.style.position = "absolute";
    closeBtn.style.top = "10px";
    closeBtn.style.right = "10px";
    closeBtn.style.zIndex = "10000";
    closeBtn.style.padding = "10px 20px";
    closeBtn.style.fontSize = "1rem";
    closeBtn.style.border = "none";
    closeBtn.style.borderRadius = "10px";
    closeBtn.style.background = "red";
    closeBtn.style.color = "white";
    closeBtn.style.cursor = "pointer";
    qrBox.appendChild(closeBtn);

    document.body.appendChild(qrBox);

    const qrScanner = new Html5Qrcode("reader");
    const config = { fps: 10, qrbox: { width: 300, height: 300 } };

    function handleQrMessage(qrCodeMessage) {
        qrScanner.stop().then(() => {
            // Interpretar si es link completo o solo un ID
            if (qrCodeMessage.startsWith("http")) {
                window.location.href = qrCodeMessage;
            } else {
                // ABRIR APP NATIVA DE SPOTIFY
                window.location.href = "spotify://track/" + qrCodeMessage;

                // FALLBACK WEB (si el deep link falla)
                setTimeout(() => {
                    window.location.href = "https://open.spotify.com/track/" + qrCodeMessage;
                }, 800);
            }
            // No mostrar la ID, cerrar el lector
            qrBox.remove();
        });
    }

    qrScanner.start({ facingMode: { exact: "environment" } }, config, handleQrMessage, errorMessage => {})
    .catch(err => {
        // fallback a cámara frontal
        qrScanner.start({ facingMode: "user" }, config, handleQrMessage, errorMessage => {})
        .catch(err2 => {
            alert("No se pudo acceder a la cámara. Revisa permisos o usa HTTPS/localhost.");
            qrBox.remove();
            console.error(err2);
        });
    });

    closeBtn.onclick = () => {
        qrScanner.stop().then(() => qrBox.remove()).catch(() => qrBox.remove());
    };
};
 
<script>
let deferredPrompt;
const installBtn = document.getElementById('installBtn');

window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault(); // evita que Chrome muestre el prompt automáticamente
    deferredPrompt = e;
    installBtn.style.display = 'block';
});

installBtn.addEventListener('click', async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt(); // muestra el prompt de instalación
    const { outcome } = await deferredPrompt.userChoice;
    console.log(`User response: ${outcome}`);
    deferredPrompt = null;
    installBtn.style.display = 'none';
});
</script>

</body>
<script>
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/hitster/sw.js')
        .then(reg => console.log('Service Worker registrado', reg))
        .catch(err => console.error('Service Worker fallo', err));
    });
}
</script>
</html>
